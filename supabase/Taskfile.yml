version: "3"

tasks:
  default:
    desc: List all available tasks
    cmds:
      - task --list

  setup:
    desc: Interactive Supabase project setup and configuration
    cmds:
      - echo "ðŸš€ Interactive Supabase Setup"
      - echo "=================================="
      - echo ""
      - echo "ðŸ“‹ This setup will:"
      - echo "   1. Install Supabase CLI if needed"
      - echo "   2. Configure your Supabase project"
      - echo "   3. Apply database migrations"
      - echo "   4. Update environment variables in root .env"
      - echo ""
      - task: setup-cli
      - task: configure-project
      - task: migrate
      - echo ""
      - echo "ðŸŽ‰ Supabase setup completed successfully!"
      - echo "ðŸ“‹ Your project is linked and configured!"
      - echo "ðŸ’¡ Run 'task seed-kb' to populate the knowledge base"
      - echo "ðŸ’¡ Run 'task start' from project root to start the application"

  setup-cli:
    desc: Install and configure Supabase CLI
    cmds:
      - echo "ðŸ”§ Setting up Supabase CLI..."
      - |
        if ! command -v supabase &> /dev/null; then
          echo "ðŸ“¦ Installing Supabase CLI..."
          # macOS
          if [[ "$OSTYPE" == "darwin"* ]]; then
            brew install supabase/tap/supabase
          # Linux
          else
            curl -L https://github.com/supabase/cli/releases/latest/download/supabase_linux_amd64.tar.gz | tar xz
            sudo mv supabase /usr/local/bin/
          fi
        else
          echo "âœ… Supabase CLI already installed"
        fi
      - supabase --version

  configure-project:
    desc: Configure Supabase project using CLI interactive selection
    dir: ../
    cmds:
      - echo "ðŸ”— Configuring Supabase project..."
      - echo ""
      - echo "ðŸ“‹ Using Supabase CLI for secure project selection"
      - echo ""
      - echo "ðŸ” Checking authentication status..."
      - |
        if supabase projects list >/dev/null 2>&1; then
          echo "âœ… Already authenticated with Supabase"
        else
          echo "ðŸ” Authentication required. Let's log in..."
          supabase login
        fi
      - echo ""
      - echo "ðŸ“‹ Linking to your Supabase project..."
      - echo "ðŸ’¡ The CLI will show your available projects and prompt you to select one"
      - echo ""
      - |
        # Check if project is already linked
        if [ -f "supabase/config.toml" ] && grep -q "project_id" "supabase/config.toml"; then
          echo "âœ… Project already linked. Using existing configuration."
        else
          echo "ðŸ”— No project linked. Linking to your Supabase project..."
          echo "ðŸ’¡ The CLI will show your available projects and prompt you to select one"
          supabase link
        fi

        # Get project name from config, then find reference ID from projects list
        project_name=$(cat supabase/config.toml 2>/dev/null | grep -o 'project_id = "[^"]*"' | cut -d'"' -f2)

        if [ -z "$project_name" ]; then
          echo "âŒ Failed to extract project name from config"
          echo "ðŸ’¡ Please ensure the project is properly linked"
          exit 1
        fi

        echo "ðŸ” Found project name: $project_name"

        # Get project reference ID from projects list using partial name matching
        echo "ðŸ” Looking up project reference ID..."
        project_ref=$(supabase projects list -o json 2>/dev/null | jq -r ".[] | select(.name | contains(\"$(echo $project_name | sed 's/agentic-//')\")) | .id")

        if [ -z "$project_ref" ] || [ "$project_ref" = "null" ]; then
          echo "âŒ Failed to find project reference ID for project: $project_name"
          echo "ðŸ’¡ Please ensure the project exists and you have access to it"
          exit 1
        fi

        echo "ðŸ” Found project reference: $project_ref"

        # Get API URL and service key from remote project
        echo "ðŸ” Fetching project credentials..."
        project_url="https://$project_ref.supabase.co"

        # Get service role key using projects API command with JSON output
        echo "ðŸ” Fetching service role key..."
        service_key=$(supabase projects api-keys --project-ref "$project_ref" -o json 2>/dev/null | jq -r '.[] | select(.name == "service_role") | .api_key')

        if [ -z "$service_key" ]; then
          echo "âŒ Failed to extract service role key"
          echo "ðŸ’¡ Please ensure you have the correct permissions"
          echo "ðŸ“‹ Alternatively, get your credentials from:"
          echo "   1. Supabase Dashboard â†’ Settings â†’ API"
          echo "   2. Copy the Project URL and service_role key"
          echo "   3. Add them manually to your .env file:"
          echo "      SUPABASE_URL=https://$project_ref.supabase.co"
          echo "      SUPABASE_SERVICE_KEY=your_service_role_key"
          exit 1
        fi

        echo "ðŸ“ Updating environment variables..."

        # Create/update .env file in project root
        env_file=".env"

        # Update or add environment variables
        if grep -q "^SUPABASE_URL=" "$env_file" 2>/dev/null; then
          sed -i.bak "s|^SUPABASE_URL=.*|SUPABASE_URL=$project_url|" "$env_file"
        else
          echo "SUPABASE_URL=$project_url" >> "$env_file"
        fi

        if grep -q "^SUPABASE_SERVICE_KEY=" "$env_file" 2>/dev/null; then
          sed -i.bak "s|^SUPABASE_SERVICE_KEY=.*|SUPABASE_SERVICE_KEY=$service_key|" "$env_file"
        else
          echo "SUPABASE_SERVICE_KEY=$service_key" >> "$env_file"
        fi

        rm -f "$env_file.bak"

        echo "âœ… Environment variables updated in .env"
        echo "   SUPABASE_URL=$project_url"
        echo "   SUPABASE_SERVICE_KEY=${service_key:0:20}..."

  migrate:
    desc: Run database migrations using Supabase CLI
    dir: ../
    cmds:
      - echo "ðŸš€ Running database migrations..."
      - supabase db push
      - echo "âœ… Migrations applied successfully!"

  test-connection:
    desc: Test Supabase connection and vector search
    dir: ../apps/api
    cmds:
      - echo "ðŸ§ª Testing Supabase connection..."
      - task test-kb

  test:
    desc: Test vector search functionality (delegates to API scripts)
    dir: ../apps/api
    cmds:
      - echo "ðŸ§ª Testing vector search..."
      - task test-kb

  clean:
    desc: Clean all documents from knowledge base (delegates to API scripts)
    dir: ../apps/api
    cmds:
      - echo "ðŸ§¹ Cleaning knowledge base..."
      - task clean-kb

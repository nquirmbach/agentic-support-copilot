version: "3"

tasks:
  default:
    desc: List all available tasks
    cmds:
      - task --list

  setup:
    desc: Initialize Terraform and deploy infrastructure
    cmds:
      - echo "ðŸ”§ Checking Azure CLI availability..."
      - |
        if ! command -v az &> /dev/null; then
          echo "âŒ Error: Azure CLI is required but not installed"
          echo "Please install it from: https://learn.microsoft.com/en-us/cli/azure/install-azure-cli"
          exit 1
        fi
        az_version=$(az --version | head -n1 | cut -d' ' -f2)
        echo "âœ… Azure CLI $az_version found"
      - echo "ðŸ”§ Checking Terraform availability..."
      - |
        if ! command -v terraform &> /dev/null; then
          echo "âŒ Error: Terraform is required but not installed"
          echo "Please install it from: https://developer.hashicorp.com/terraform/downloads"
          exit 1
        fi
        tf_version=$(terraform version -json | jq -r '.terraform_version')
        echo "âœ… Terraform $tf_version found"
      - echo "ðŸ” Checking Azure authentication..."
      - |
        if ! az account show &> /dev/null; then
          echo "Please login to Azure:"
          az login
        else
          echo "âœ… Already authenticated with Azure"
        fi
      - echo "ðŸ“¦ Initializing Terraform..."
      - terraform init
      - echo "ðŸš€ Deploying infrastructure..."
      - terraform apply

  plan:
    desc: Show Terraform execution plan
    cmds:
      - terraform plan

  destroy:
    desc: Destroy all Azure resources
    cmds:
      - terraform destroy

  clean:
    desc: Clean Terraform files and generated artifacts
    cmds:
      - rm -rf .terraform
      - rm -f .terraform.lock.hcl
      - rm -f terraform.tfstate*
      - rm -f azure.env terraform_outputs.json tfplan

  init:
    desc: Initialize Terraform providers
    cmds:
      - terraform init

  outputs:
    desc: Show Terraform outputs
    cmds:
      - terraform output

  env:
    desc: Generate environment variables file
    cmds:
      - terraform output environment_variables -json | jq -r 'to_entries[] | "\(.key)=\(.value)"' > azure.env
      - echo "Environment variables saved to azure.env"

  validate:
    desc: Validate Terraform configuration
    cmds:
      - terraform validate
      - terraform fmt -check

  status:
    desc: Show current deployment status
    cmds:
      - terraform show
